<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½çœä»½æ´»è·ƒåº¦åœ°å›¾</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.6.0/echarts.min.js"></script>
    <script src="/static/js/china.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 30px;
        }

        .map-container {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 100px 0;
            color: #666;
            font-size: 16px;
        }

        .error {
            text-align: center;
            padding: 50px 0;
            color: #e74c3c;
            font-size: 16px;
        }

        .legend {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ºï¸ ä¸­å›½çœä»½æ´»è·ƒåº¦ç»Ÿè®¡</h1>
            <p>å®æ—¶å±•ç¤ºå„çœä»½ç”¨æˆ·æ´»è·ƒæƒ…å†µ</p>
        </div>

        <div class="content">
            <div id="mapChart" class="map-container">
                <div class="loading">â³ æ­£åœ¨åŠ è½½åœ°å›¾æ•°æ®...</div>
            </div>


            <div class="stats-grid" id="statsGrid">
                <!-- ç»Ÿè®¡å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // ä¸­å›½çœä»½åç§°æ˜ å°„ - EChartsä½¿ç”¨çš„æ ‡å‡†åç§°
        const provinceNameMap = {
            'åŒ—äº¬': 'åŒ—äº¬',
            'å¤©æ´¥': 'å¤©æ´¥',
            'æ²³åŒ—': 'æ²³åŒ—',
            'å±±è¥¿': 'å±±è¥¿',
            'å†…è’™å¤': 'å†…è’™å¤',
            'è¾½å®': 'è¾½å®',
            'å‰æ—': 'å‰æ—',
            'é»‘é¾™æ±Ÿ': 'é»‘é¾™æ±Ÿ',
            'ä¸Šæµ·': 'ä¸Šæµ·',
            'æ±Ÿè‹': 'æ±Ÿè‹',
            'æµ™æ±Ÿ': 'æµ™æ±Ÿ',
            'å®‰å¾½': 'å®‰å¾½',
            'ç¦å»º': 'ç¦å»º',
            'æ±Ÿè¥¿': 'æ±Ÿè¥¿',
            'å±±ä¸œ': 'å±±ä¸œ',
            'æ²³å—': 'æ²³å—',
            'æ¹–åŒ—': 'æ¹–åŒ—',
            'æ¹–å—': 'æ¹–å—',
            'å¹¿ä¸œ': 'å¹¿ä¸œ',
            'å¹¿è¥¿': 'å¹¿è¥¿',
            'æµ·å—': 'æµ·å—',
            'é‡åº†': 'é‡åº†',
            'å››å·': 'å››å·',
            'è´µå·': 'è´µå·',
            'äº‘å—': 'äº‘å—',
            'è¥¿è—': 'è¥¿è—',
            'é™•è¥¿': 'é™•è¥¿',
            'ç”˜è‚ƒ': 'ç”˜è‚ƒ',
            'é’æµ·': 'é’æµ·',
            'å®å¤': 'å®å¤',
            'æ–°ç–†': 'æ–°ç–†',
            'ä¸­å›½å°æ¹¾': 'å°æ¹¾',
            'ä¸­å›½é¦™æ¸¯': 'é¦™æ¸¯',
            'ä¸­å›½æ¾³é—¨': 'æ¾³é—¨'
        };

        // åˆå§‹åŒ–å›¾è¡¨
        const chart = echarts.init(document.getElementById('mapChart'));

        {#// æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå‡½æ•°ï¼ˆç”¨äºæµ‹è¯•ï¼Œå®é™…ä½¿ç”¨æ—¶åˆ é™¤ï¼‰#}
        {#function generateMockData() {#}
        {#    const provinces = Object.keys(provinceNameMap);#}
        {#    return provinces.map(province => ({#}
        {#        name: province,#}
        {#        value: Math.floor(Math.random() * 2000) + 50#}
        {#    }));#}
        {#  #}

        // è·å–åç«¯æ•°æ®
        async function fetchProvinceData() {
            try {
                const response = await fetch('/page/api/china_province_activity');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // è½¬æ¢ä»åç«¯è·å–çš„æ´»è·ƒåº¦å¯¹è±¡ä¸ºEChartsæ‰€éœ€çš„æ•°ç»„æ ¼å¼
                const processedData = Object.keys(data).map(provinceName => ({
                    name: provinceNameMap[provinceName] || provinceName,
                    value: data[provinceName].heatIndex || 0 // ä½¿ç”¨ heatIndex ä½œä¸ºæ´»è·ƒåº¦å€¼
                }));

                return processedData;

            } catch (error) {
                console.error('è·å–çœä»½æ•°æ®å¤±è´¥:', error);
                // å¦‚æœåç«¯æ¥å£å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤º
                console.warn('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤º');
                return generateMockData();
            }
        }

        // æ¸²æŸ“åœ°å›¾
        function renderMap(data) {
            // æ•°æ®é¢„å¤„ç†
            const processedData = data.map(item => ({
                name: provinceNameMap[item.name] || item.name,
                value: item.value || 0
            }));

            // è®¡ç®—æ•°æ®èŒƒå›´
            const values = processedData.map(item => item.value);
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);

            const option = {
                title: {
                    text: 'çœä»½æ´»è·ƒåº¦åˆ†å¸ƒï¼ˆæš‚æ— æ¸¯æ¾³å°æ•°æ®ï¼‰',
                    left: 'center',
                    textStyle: {
                        fontSize: 20,
                        fontWeight: 'bold',
                        color: '#333'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.data && params.data.value !== undefined) {
                            return `
                                <div style="padding: 10px;">
                                    <strong>${params.data.name}</strong><br/>
                                    æ´»è·ƒåº¦: <span style="color: #667eea; font-weight: bold;">${params.data.value}</span>
                                </div>
                            `;
                        }
                        return `${params.name}<br/>æš‚æ— æ•°æ®`;
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    textStyle: {
                        color: '#333',
                        fontSize: 14
                    }
                },
                visualMap: {
                    left: 'left',
                    top: 'bottom',
                    type: 'piecewise', // æ›´æ”¹ä¸ºåˆ†æ®µå¼è§†è§‰æ˜ å°„
                    pieces: [
                        {gt: 60000, label: 'æé«˜æ´»è·ƒåº¦', color: '#d94e5d'},
                        {gt: 30000, lte: 60000, label: 'é«˜æ´»è·ƒåº¦', color: '#ff704d'},
                        {gt: 1000, lte: 30000, label: 'ä¸­ç­‰æ´»è·ƒåº¦ ', color: '#ffb548'},
                        {gt: 0, lte: 10000, label: 'ä¸€èˆ¬æ´»è·ƒåº¦', color: '#6ee094'},
                        {value: 0, label: 'æ— æ•°æ®/æä½æ´»è·ƒåº¦', color: '#a8e6cf'}
                    ],
                    orient: 'vertical',
                    inRange: {
                        color: ['#a8e6cf', '#6bcf7f', '#ffb548', '#ff704d', '#d94e5d']
                    },
                    textStyle: {
                        color: '#333'
                    }
                },
                series: [{
                    name: 'çœä»½æ´»è·ƒåº¦',
                    type: 'map',
                    map: 'china',
                    emphasis: {
                        label: {
                            show: true,
                            color: '#fff'
                        },
                        itemStyle: {
                            areaColor: '#667eea',
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    },
                    select: {
                        label: {
                            show: true,
                            color: '#fff'
                        },
                        itemStyle: {
                            areaColor: '#764ba2'
                        }
                    },
                    data: processedData,
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 1
                    },
                    label: {
                        show: false
                    }
                }]
            };

            chart.setOption(option);
        }

        // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
        function renderStats(data) {
            const totalActivity = data.reduce((sum, item) => sum + (item.value || 0), 0);
            const maxActivity = Math.max(...data.map(item => item.value || 0));
            const avgActivity = Math.round(totalActivity / data.length);
            const activeProvinces = data.filter(item => item.value > 100).length;

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${totalActivity.toLocaleString()}</div>
                    <div class="stat-label">æ€»æ´»è·ƒåº¦</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                    <div class="stat-number">${maxActivity}</div>
                    <div class="stat-label">æœ€é«˜æ´»è·ƒåº¦</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                    <div class="stat-number">${avgActivity}</div>
                    <div class="stat-label">å¹³å‡æ´»è·ƒåº¦</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="stat-number">${activeProvinces}</div>
                    <div class="stat-label">æ´»è·ƒçœä»½æ•°</div>
                </div>
            `;

            document.getElementById('statsGrid').innerHTML = statsHtml;
        }

        // ä¸»åˆå§‹åŒ–å‡½æ•°
        async function initializeMap() {
            try {
                // é¦–å…ˆå°è¯•æ³¨å†Œä¸­å›½åœ°å›¾
                if (!echarts.getMap('china')) {
                    // å¦‚æœæ²¡æœ‰ä¸­å›½åœ°å›¾æ•°æ®ï¼Œä½¿ç”¨åœ¨çº¿CDNåŠ è½½
                    const mapResponse = await fetch('https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/map/js/china.js');
                    if (mapResponse.ok) {
                        const mapScript = await mapResponse.text();
                        eval(mapScript);
                    } else {
                        throw new Error('æ— æ³•åŠ è½½ä¸­å›½åœ°å›¾æ•°æ®');
                    }
                }

                // è·å–çœä»½æ´»è·ƒåº¦æ•°æ®
                const provinceData = await fetchProvinceData();

                // æ¸²æŸ“åœ°å›¾å’Œç»Ÿè®¡ä¿¡æ¯
                renderMap(provinceData);
                renderStats(provinceData);

            } catch (error) {
                console.error('åˆå§‹åŒ–åœ°å›¾å¤±è´¥:', error);
                document.getElementById('mapChart').innerHTML =
                    '<div class="error">âŒ åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</div>';
            }
        }

        // å“åº”å¼å¤„ç†
        window.addEventListener('resize', function() {
            chart.resize();
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();

            // æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°æ•°æ®
            setInterval(async function() {
                try {
                    const provinceData = await fetchProvinceData();
                    renderMap(provinceData);
                    renderStats(provinceData);
                    console.log('æ•°æ®å·²è‡ªåŠ¨åˆ·æ–°');
                } catch (error) {
                    console.error('è‡ªåŠ¨åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                }
            }, 5 * 60 * 1000);
        });
    </script>
</body>
</html>