<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国省份活跃度地图</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.6.0/echarts.min.js"></script>
    <script src="/static/js/china.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 30px;
        }

        .map-container {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 100px 0;
            color: #666;
            font-size: 16px;
        }

        .error {
            text-align: center;
            padding: 50px 0;
            color: #e74c3c;
            font-size: 16px;
        }

        .legend {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🗺️ 中国省份活跃度统计</h1>
            <p>实时展示各省份用户活跃情况</p>
        </div>

        <div class="content">
            <div id="mapChart" class="map-container">
                <div class="loading">⏳ 正在加载地图数据...</div>
            </div>


            <div class="stats-grid" id="statsGrid">
                <!-- 统计卡片将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 中国省份名称映射 - ECharts使用的标准名称
        const provinceNameMap = {
            '北京': '北京',
            '天津': '天津',
            '河北': '河北',
            '山西': '山西',
            '内蒙古': '内蒙古',
            '辽宁': '辽宁',
            '吉林': '吉林',
            '黑龙江': '黑龙江',
            '上海': '上海',
            '江苏': '江苏',
            '浙江': '浙江',
            '安徽': '安徽',
            '福建': '福建',
            '江西': '江西',
            '山东': '山东',
            '河南': '河南',
            '湖北': '湖北',
            '湖南': '湖南',
            '广东': '广东',
            '广西': '广西',
            '海南': '海南',
            '重庆': '重庆',
            '四川': '四川',
            '贵州': '贵州',
            '云南': '云南',
            '西藏': '西藏',
            '陕西': '陕西',
            '甘肃': '甘肃',
            '青海': '青海',
            '宁夏': '宁夏',
            '新疆': '新疆',
            '中国台湾': '台湾',
            '中国香港': '香港',
            '中国澳门': '澳门'
        };

        // 初始化图表
        const chart = echarts.init(document.getElementById('mapChart'));

        {#// 模拟数据生成函数（用于测试，实际使用时删除）#}
        {#function generateMockData() {#}
        {#    const provinces = Object.keys(provinceNameMap);#}
        {#    return provinces.map(province => ({#}
        {#        name: province,#}
        {#        value: Math.floor(Math.random() * 2000) + 50#}
        {#    }));#}
        {#  #}

        // 获取后端数据
        async function fetchProvinceData() {
            try {
                const response = await fetch('/page/api/china_province_activity');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // 转换从后端获取的活跃度对象为ECharts所需的数组格式
                const processedData = Object.keys(data).map(provinceName => ({
                    name: provinceNameMap[provinceName] || provinceName,
                    value: data[provinceName].heatIndex || 0 // 使用 heatIndex 作为活跃度值
                }));

                return processedData;

            } catch (error) {
                console.error('获取省份数据失败:', error);
                // 如果后端接口失败，使用模拟数据进行演示
                console.warn('使用模拟数据进行演示');
                return generateMockData();
            }
        }

        // 渲染地图
        function renderMap(data) {
            // 数据预处理
            const processedData = data.map(item => ({
                name: provinceNameMap[item.name] || item.name,
                value: item.value || 0
            }));

            // 计算数据范围
            const values = processedData.map(item => item.value);
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);

            const option = {
                title: {
                    text: '省份活跃度分布（暂无港澳台数据）',
                    left: 'center',
                    textStyle: {
                        fontSize: 20,
                        fontWeight: 'bold',
                        color: '#333'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.data && params.data.value !== undefined) {
                            return `
                                <div style="padding: 10px;">
                                    <strong>${params.data.name}</strong><br/>
                                    活跃度: <span style="color: #667eea; font-weight: bold;">${params.data.value}</span>
                                </div>
                            `;
                        }
                        return `${params.name}<br/>暂无数据`;
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    textStyle: {
                        color: '#333',
                        fontSize: 14
                    }
                },
                visualMap: {
                    left: 'left',
                    top: 'bottom',
                    type: 'piecewise', // 更改为分段式视觉映射
                    pieces: [
                        {gt: 60000, label: '极高活跃度', color: '#d94e5d'},
                        {gt: 30000, lte: 60000, label: '高活跃度', color: '#ff704d'},
                        {gt: 1000, lte: 30000, label: '中等活跃度 ', color: '#ffb548'},
                        {gt: 0, lte: 10000, label: '一般活跃度', color: '#6ee094'},
                        {value: 0, label: '无数据/极低活跃度', color: '#a8e6cf'}
                    ],
                    orient: 'vertical',
                    inRange: {
                        color: ['#a8e6cf', '#6bcf7f', '#ffb548', '#ff704d', '#d94e5d']
                    },
                    textStyle: {
                        color: '#333'
                    }
                },
                series: [{
                    name: '省份活跃度',
                    type: 'map',
                    map: 'china',
                    emphasis: {
                        label: {
                            show: true,
                            color: '#fff'
                        },
                        itemStyle: {
                            areaColor: '#667eea',
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    },
                    select: {
                        label: {
                            show: true,
                            color: '#fff'
                        },
                        itemStyle: {
                            areaColor: '#764ba2'
                        }
                    },
                    data: processedData,
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 1
                    },
                    label: {
                        show: false
                    }
                }]
            };

            chart.setOption(option);
        }

        // 渲染统计卡片
        function renderStats(data) {
            const totalActivity = data.reduce((sum, item) => sum + (item.value || 0), 0);
            const maxActivity = Math.max(...data.map(item => item.value || 0));
            const avgActivity = Math.round(totalActivity / data.length);
            const activeProvinces = data.filter(item => item.value > 100).length;

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${totalActivity.toLocaleString()}</div>
                    <div class="stat-label">总活跃度</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                    <div class="stat-number">${maxActivity}</div>
                    <div class="stat-label">最高活跃度</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                    <div class="stat-number">${avgActivity}</div>
                    <div class="stat-label">平均活跃度</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="stat-number">${activeProvinces}</div>
                    <div class="stat-label">活跃省份数</div>
                </div>
            `;

            document.getElementById('statsGrid').innerHTML = statsHtml;
        }

        // 主初始化函数
        async function initializeMap() {
            try {
                // 首先尝试注册中国地图
                if (!echarts.getMap('china')) {
                    // 如果没有中国地图数据，使用在线CDN加载
                    const mapResponse = await fetch('https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/map/js/china.js');
                    if (mapResponse.ok) {
                        const mapScript = await mapResponse.text();
                        eval(mapScript);
                    } else {
                        throw new Error('无法加载中国地图数据');
                    }
                }

                // 获取省份活跃度数据
                const provinceData = await fetchProvinceData();

                // 渲染地图和统计信息
                renderMap(provinceData);
                renderStats(provinceData);

            } catch (error) {
                console.error('初始化地图失败:', error);
                document.getElementById('mapChart').innerHTML =
                    '<div class="error">❌ 地图加载失败，请检查网络连接或稍后重试</div>';
            }
        }

        // 响应式处理
        window.addEventListener('resize', function() {
            chart.resize();
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();

            // 每5分钟自动刷新数据
            setInterval(async function() {
                try {
                    const provinceData = await fetchProvinceData();
                    renderMap(provinceData);
                    renderStats(provinceData);
                    console.log('数据已自动刷新');
                } catch (error) {
                    console.error('自动刷新数据失败:', error);
                }
            }, 5 * 60 * 1000);
        });
    </script>
</body>
</html>